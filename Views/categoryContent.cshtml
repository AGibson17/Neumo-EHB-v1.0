@inherits UmbracoViewPage<Umbraco.Cms.Web.Common.PublishedModels.HandbookCategoryCard>
@{
    Layout = "~/Views/Layouts/_Layout.cshtml";
}

<div class="category-page">
    <!-- Category Header -->
    <div class="category-page__header">
        <div class="content-width">
            <!-- Breadcrumb Navigation -->
            <nav class="navigation-breadcrumb" aria-label="breadcrumb">
                <a href="@Model.Parent.Url()#handbook" 
                   class="breadcrumb__back-button"
                   onclick="handleBreadcrumbNavigation(event, this)">
                    <i data-lucide="arrow-left" class="breadcrumb__back-button__icon"></i>
                    <span>Back to Handbook</span>
                </a>
            </nav>
            
            <!-- Category Title & Description -->
            <div class="category-page__title-section">
                <div class="flex-container--between flex-container--gap">
                    <div class="category-page__content">
                        <h1 class="category-page__title neumo-heading-bold">
                            @Model.CategoryTitle
                        </h1>
                        <p class="category-page__description neumo-body">
                            @Model.CategoryDescription
                        </p>
                    </div>
                    <div class="category-page__icon">
                        <div class="category-icon-wrapper">
                            <i data-lucide="folder-open"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Links to Other Categories -->
    <div class="category-page__quick-links" 
         :class="{ 'floating-nav': isFloatingNavVisible, 'floating-nav--expanded': isFloatingNavExpanded }"
         ref="quickLinksSection">
        <div class="content-width" :class="{ 'floating-nav__container': isFloatingNavVisible }">
            <div class="quick-links-section" :class="{ 'floating-nav__header': isFloatingNavVisible }">
                <div class="quick-links-section__header">
                    <h3 class="quick-links-section__title neumo-heading-bold" :class="{ 'floating-nav__label': isFloatingNavVisible }">
                        <i data-lucide="external-link"></i>
                        <span v-if="!isFloatingNavVisible">Other Categories</span>
                        <span v-else>Quick Links</span>
                    </h3>
                    @{
                        // Get all categories from the parent homepage
                        var homepage = Model.AncestorOrSelf("HandbookHomePage") as Umbraco.Cms.Web.Common.PublishedModels.HandbookHomePage;
                        var otherCategories = homepage?.CategoriesToDisplay?.Where(cat => 
                            cat.ContentType.Alias == "HandbookCategoryCard" && cat.Id != Model.Id) ?? Enumerable.Empty<IPublishedContent>();
                        var categoryCount = otherCategories.Count();
                    }
                    @if (categoryCount > 0)
                    {
                        <span class="badge badge-primary" v-show="!isFloatingNavVisible">
                            @categoryCount @(categoryCount == 1 ? "Category" : "Categories")
                        </span>
                    }
                    
                    <!-- Floating Nav Toggle Button (only visible when floating) -->
                    <button type="button" 
                            class="floating-nav__toggle" 
                            @click="toggleFloatingNav"
                            :aria-expanded="isFloatingNavExpanded.toString()"
                            v-show="isFloatingNavVisible">
                        <i :data-lucide="isFloatingNavExpanded ? 'chevron-down' : 'chevron-right'"></i>
                    </button>
                </div>
                
                @if (otherCategories.Any())
                {
                    <div class="quick-links-buttons-grid" 
                         :class="{ 'floating-nav__content': isFloatingNavVisible, 'floating-nav__quick-links': isFloatingNavVisible }"
                         v-show="!isFloatingNavVisible || isFloatingNavExpanded">
                        @foreach (var category in otherCategories)
                        {
                            var typedCategory = category as Umbraco.Cms.Web.Common.PublishedModels.HandbookCategoryCard;
                            if (typedCategory != null)
                            {
                                var categoryPolicyCount = typedCategory.Children?.Where(c => c.ContentType.Alias == "policyCard")?.Count() ?? 0;
                                
                                <a href="@typedCategory.Url()" 
                                   :class="isFloatingNavVisible ? 'floating-nav__link' : 'quick-link-button'" 
                                   data-category-transition
                                   @@click="trackCategoryClick('@typedCategory.CategoryTitle')">
                                    <div :class="isFloatingNavVisible ? 'floating-nav__link-content' : 'quick-link-button__content'">
                                        <div v-if="!isFloatingNavVisible" class="quick-link-button__text">
                                            <h4 class="quick-link-button__title neumo-subhead">@typedCategory.CategoryTitle</h4>
                                            <span class="quick-link-button__meta badge badge-secondary">
                                                @categoryPolicyCount @(categoryPolicyCount == 1 ? "Policy" : "Policies")
                                            </span>
                                        </div>
                                        <div v-else>
                                            <h4 class="floating-nav__link-title">@typedCategory.CategoryTitle</h4>
                                            <span class="floating-nav__link-meta">
                                                @categoryPolicyCount @(categoryPolicyCount == 1 ? "Policy" : "Policies")
                                            </span>
                                        </div>
                                        <div :class="isFloatingNavVisible ? 'floating-nav__link-icon' : 'quick-link-button__icon'">
                                            <i data-lucide="arrow-right"></i>
                                        </div>
                                    </div>
                                </a>
                            }
                        }
                    </div>
                }
                else
                {
                    <div class="quick-links-empty" v-show="!isFloatingNavVisible">
                        <p class="neumo-body text-muted">No other categories available.</p>
                    </div>
                }
            </div>
        </div>
    </div>
    
    <!-- Category Content -->
    <div class="category-page__content">
        <div class="content-width">
            <!-- Policy Cards Grid -->
            <div class="policy-grid">
                <div class="policy-grid__header">
                    <h2 class="neumo-heading-bold">Policies in this Category</h2>
                    <span class="badge badge-secondary">
                        @{
                            var policyCount = Model.Children?.Where(x => x.ContentType.Alias == "policyCard").Count() ?? 0;
                        }
                        @policyCount Policies
                    </span>
                </div>
                
                <div class="policy-grid__container">
                    @if (Model.Children?.Any(x => x.ContentType.Alias == "policyCard") == true)
                    {
                        @foreach (var policy in Model.Children.Where(x => x.ContentType.Alias == "policyCard"))
                        {
                            var typedPolicy = policy as Umbraco.Cms.Web.Common.PublishedModels.PolicyCard;
                            @await Html.PartialAsync("~/Views/Partials/UI/_PolicyCard.cshtml", typedPolicy)
                        }
                    }
                    else
                    {
                        <div class="empty-state">
                            <div class="empty-state__content">
                                <i data-lucide="file-x"></i>
                                <h3 class="empty-state__title neumo-heading-bold">No Policies Available</h3>
                                <p class="empty-state__description neumo-body">
                                    Policies will appear here as they are added to this category.
                                </p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Set the active tab BEFORE DOMContentLoaded to ensure sidebar picks it up
    localStorage.setItem('activeTab', 'handbook');

    // Initialize Lucide icons for category page
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // Set Employee Handbook nav item as active when viewing category pages
        // Use setTimeout to ensure this runs after the sidebar's DOMContentLoaded
        setTimeout(function() {
            setHandbookNavActive();
        }, 0);
        
        // Also update mobile menu if it exists
        updateMobileMenuActiveState('handbook');
        
        // Initialize category page transitions
        initializeCategoryTransitions();
        
        // Initialize Vue.js app for floating navigation
        initializeFloatingNavApp();

        // Ensure only one policy accordion (<details>) is open at a time
        const policyAccordions = Array.from(document.querySelectorAll('.policy-accordion'));
        policyAccordions.forEach((item) => {
            item.addEventListener('toggle', () => {
                if (item.open) {
                    policyAccordions.forEach(other => {
                        if (other !== item && other.open) {
                            other.open = false;
                        }
                    });
                }
            });
        });

        // If there's a policy hash in the URL, open and scroll to it
        handlePolicyHashDeepLink();
    });
    
    function handleBreadcrumbNavigation(event, element) {
        event.preventDefault();
        
        // Add fade out effect
        document.body.classList.add('page-transitioning-out');
        
        setTimeout(function() {
            // Navigate to the parent page
            const parentUrl = element.href.split('#')[0];
            window.location.href = parentUrl;
            
            // Set the active tab to handbook when the page loads
            localStorage.setItem('activeTab', 'handbook');
        }, 150);
    }
    
    function initializeCategoryTransitions() {
        // Add fade in effect when page loads
        document.body.classList.add('page-fade-in');
        
        // Handle category navigation links with transitions
        const categoryLinks = document.querySelectorAll('[data-category-transition]');
        categoryLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const href = this.href;
                
                // Add fade out effect
                document.body.classList.add('page-transitioning-out');
                
                // Navigate after transition
                setTimeout(function() {
                    window.location.href = href;
                }, 150);
            });
        });
    }
    
    function setHandbookNavActive() {
        // Remove active class from all nav items
        const navItems = document.querySelectorAll('.sidebar-nav__button');
        navItems.forEach(item => {
            item.classList.remove('sidebar-nav__button--active');
        });
        
        // Add active class to handbook nav item
        const handbookNavItem = document.querySelector('[data-tab="handbook"]');
        if (handbookNavItem) {
            handbookNavItem.classList.add('sidebar-nav__button--active');
        }
        
        // Store the active tab
        localStorage.setItem('activeTab', 'handbook');
    }

    function handlePolicyHashDeepLink() {
        const hash = window.location.hash;
        if (!hash || !hash.startsWith('#policy-')) return;
        const id = hash.replace('#policy-', '').trim();
        if (!id) return;
        const target = document.getElementById(`policy-${id}`) || document.querySelector(`[data-policy-id="${id}"]`);
        if (!target) return;

        // Close others and open the target
        const all = document.querySelectorAll('.policy-accordion');
        all.forEach(el => {
            el.open = (el === target);
        });

        // Smooth scroll into view and add a temporary highlight
        setTimeout(() => {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            target.classList.add('policy-accordion--highlight');
            setTimeout(() => target.classList.remove('policy-accordion--highlight'), 1500);
        }, 50);
    }
    
    /**
     * Vue.js Floating Navigation System
     * Transforms existing quick links into floating nav when scrolled out of view
     */
    function initializeFloatingNavApp() {
        const { createApp } = Vue;
        
        const floatingNavApp = createApp({
            data() {
                return {
                    isFloatingNavVisible: false,
                    isFloatingNavExpanded: false,
                    ticking: false
                };
            },
            mounted() {
                this.initializeScrollHandler();
                console.log('Vue.js floating navigation initialized');
            },
            methods: {
                initializeScrollHandler() {
                    const handleScroll = () => {
                        if (!this.ticking) {
                            requestAnimationFrame(() => {
                                const quickLinksRect = this.$refs.quickLinksSection.getBoundingClientRect();
                                const viewportHeight = window.innerHeight;
                                const scrollY = window.scrollY;
                                
                                // Show floating nav when quick links section is completely out of view
                                const shouldShow = quickLinksRect.bottom < 0;
                                
                                console.log('Vue scroll check:', {
                                    quickLinksBottom: quickLinksRect.bottom,
                                    quickLinksTop: quickLinksRect.top,
                                    scrollY: scrollY,
                                    viewportHeight: viewportHeight,
                                    shouldShow: shouldShow,
                                    currentlyVisible: this.isFloatingNavVisible
                                });
                                
                                if (shouldShow && !this.isFloatingNavVisible) {
                                    this.isFloatingNavVisible = true;
                                    this.isFloatingNavExpanded = false; // Start collapsed
                                    console.log('Vue: Showing floating nav - quick links out of view');
                                    this.recreateIcons();
                                } else if (!shouldShow && this.isFloatingNavVisible) {
                                    this.isFloatingNavVisible = false;
                                    this.isFloatingNavExpanded = false;
                                    console.log('Vue: Hiding floating nav - quick links visible');
                                }
                                
                                this.ticking = false;
                            });
                            this.ticking = true;
                        }
                    };
                    
                    window.addEventListener('scroll', handleScroll, { passive: true });
                    
                    // Initial check
                    setTimeout(() => handleScroll(), 100);
                },
                
                toggleFloatingNav() {
                    this.isFloatingNavExpanded = !this.isFloatingNavExpanded;
                    console.log('Vue: Toggle floating nav expanded:', this.isFloatingNavExpanded);
                    
                    // Recreate icons after DOM update
                    this.$nextTick(() => {
                        this.recreateIcons();
                    });
                },
                
                trackCategoryClick(categoryName) {
                    console.log('Vue: Category clicked:', categoryName);
                    // Add any tracking logic here
                },
                
                recreateIcons() {
                    if (window.lucide && typeof window.lucide.createIcons === 'function') {
                        setTimeout(() => {
                            window.lucide.createIcons();
                        }, 50);
                    }
                }
            }
        });
        
        floatingNavApp.mount('.category-page__quick-links');
    }
</script>