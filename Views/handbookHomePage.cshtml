@inherits UmbracoViewPage<Umbraco.Cms.Web.Common.PublishedModels.HandbookHomePage>
@{
    Layout = "~/Views/Layouts/_Layout.cshtml";
}

<!-- Main content container with tab-based switching -->
<div id="main-content" class="main-content">
    
    <!-- Welcome Tab Content -->
    <div id="content-welcome" class="tab-content tab-content--active">
        @await Html.PartialAsync("~/Views/Partials/Shared/_WelcomeContent.cshtml")
    </div>

    <!-- Guide Tab Content -->
    <div id="content-guide" class="tab-content">
        @await Html.PartialAsync("~/Views/Partials/Shared/_GuideContents.cshtml")
    </div>

    <!-- Handbook Tab Content -->
    <div id="content-handbook" class="tab-content">
        <div class="handbook-content">
            <div class="content-width">

                <!-- Header -->
                <div class="handbook-header">
                    <div class="handbook-header__content">
                        <h2 class="handbook-header__title neumo-heading-bold">
                            @(Model.PageTitle ?? "Employee Handbook")
                        </h2>

                        @if (!string.IsNullOrWhiteSpace(Model.IntroText?.ToHtmlString()))
                        {
                            <div class="handbook-header__description neumo-body">
                                @Html.Raw(Model.IntroText)
                            </div>
                        }
                        else
                        {
                            <p class="handbook-header__description neumo-body">
                                Browse policy categories to find the information you need.
                            </p>
                        }
                    </div>

                    <div class="handbook-header__icon">
                        <i data-lucide="book-open"></i>
                    </div>
                </div>

                <!-- Vue-powered Search Component -->
                <div id="handbookSearchApp" class="handbook-search">
                    <div class="handbook-search__container">
                        <div class="handbook-search__header">
                            <h2 class="neumo-heading-bold">Find What You Need</h2>
                            <p class="neumo-body">Search through policies, procedures, and handbook content</p>
                        </div>

                        <div class="handbook-search__input-wrapper" 
                             role="combobox" 
                             v-bind:aria-expanded="showResults ? 'true' : 'false'" 
                             aria-owns="searchResults" 
                             aria-haspopup="listbox">
                            <input 
                                type="text" 
                                class="handbook-search__input neumo-body" 
                                placeholder="Search policies, keywords, or topics..."
                                v-model="searchQuery"
                                v-on:focus="handleFocus"
                                v-on:keydown="handleKeydown"
                                aria-autocomplete="list"
                                aria-controls="searchResults"
                                v-bind:aria-activedescendant="activeDescendant"
                                autocomplete="off"
                            />
                            <!-- Wrap icon so absolute positioning survives Lucide replacement -->
                            <span class="handbook-search__icon"><i data-lucide="search"></i></span>
                            <button class="handbook-search__clear" 
                                    type="button" 
                                    aria-label="Clear search"
                                    v-bind:class="{ 'visible': searchQuery.length > 0 }"
                                    v-on:click="clearSearch">
                                <i data-lucide="x"></i>
                            </button>

                            <!-- Search Results Dropdown -->
                            <div class="handbook-search__results" 
                                 id="searchResults" 
                                 role="listbox" 
                                 aria-label="Search results"
                                 v-bind:class="{ 'handbook-search__results--visible': showResults }">
                                
                                <!-- Enhanced Loading State -->
                                <div v-if="showLoadingState" class="handbook-search__loading">
                                    <div class="handbook-search__loading-spinner">
                                        <i data-lucide="loader-2"></i>
                                    </div>
                                    <div class="handbook-search__loading-text">
                                        <span>Searching handbook...</span>
                                        <small>Finding relevant policies and content</small>
                                    </div>
                                </div>
                                
                                <!-- Search History -->
                                <div v-else-if="showHistory && searchHistory.length > 0" class="handbook-search__history">
                                    <div class="handbook-search__history-header">
                                        <h4>Recent Searches</h4>
                                        <button type="button" 
                                                class="handbook-search__history-clear"
                                                v-on:click="clearSearchHistory"
                                                aria-label="Clear search history">
                                            <i data-lucide="x"></i>
                                        </button>
                                    </div>
                                    <div class="handbook-search__history-list">
                                        <button v-for="(item, index) in searchHistory"
                                                v-bind:key="index"
                                                type="button"
                                                class="handbook-search__history-item"
                                                v-on:click="selectHistoryItem(item)">
                                            <i data-lucide="clock"></i>
                                            <span>{{ item }}</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Empty State -->
                                <div v-else-if="showEmptyState" class="handbook-search__empty-state">
                                    <i data-lucide="search"></i>
                                    <h3>Start Typing to Search</h3>
                                    <p>Enter keywords to find relevant policies and information</p>
                                </div>
                                
                                <!-- Minimum Characters Message -->
                                <div v-else-if="searchQuery.length < 2" class="handbook-search__empty-state">
                                    <i data-lucide="type"></i>
                                    <h3>Keep Typing...</h3>
                                    <p>Enter at least 2 characters to search</p>
                                </div>
                                
                                <!-- No Results -->
                                <div v-else-if="showNoResultsState" class="handbook-search__no-results">
                                    <div class="handbook-search__no-results-icon">
                                        <i data-lucide="search-x"></i>
                                    </div>
                                    <h3>No Results Found</h3>
                                    <p>Sorry, we couldn't find any policies or content matching "{{ searchQuery }}"</p>
                                    <div class="handbook-search__no-results-suggestions">
                                        <h4>Try:</h4>
                                        <ul>
                                            <li>Different keywords or phrases</li>
                                            <li>More general terms</li>
                                            <li>Checking for typos</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <!-- Search Results -->
                                <div v-else-if="hasResults">
                                    <div class="handbook-search__results-header">
                                        <div class="handbook-search__results-count">
                                            <strong>{{ resultsCount }}</strong> result{{ resultsCount === 1 ? '' : 's' }} found
                                        </div>
                                        <div v-if="searchPerformanceText" class="handbook-search__results-performance">
                                            {{ searchPerformanceText }}
                                        </div>
                                    </div>
                                    <div v-for="(result, index) in searchResults" 
                                         v-bind:key="index"
                                         class="handbook-search__result-item"
                                         v-bind:class="{ 'handbook-search__result-item--active': activeIndex === index }"
                                         v-bind:id="'result-' + index"
                                         role="option"
                                         v-bind:aria-selected="activeIndex === index ? 'true' : 'false'"
                                         v-on:click="selectResult(result)"
                                         v-on:mouseenter="activeIndex = index">
                                        <div class="handbook-search__result-item__title"
                                             v-html="highlightQuery(result.title, searchQuery)">
                                        </div>
                                        <div class="handbook-search__result-item__excerpt"
                                             v-html="createSearchSnippet(result.description, searchQuery, 120)">
                                        </div>
                                        <span class="handbook-search__result-item__category">
                                            {{ result.category }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories -->
                <div class="categories-section">
                    <div class="categories-section__header">
                        <h3 class="categories-section__title neumo-heading-bold">Policy Categories</h3>
                        <span class="badge badge-secondary">
                            @{
                                var count = Model.CategoriesToDisplay?.Count() ?? 0;
                            }
                            @count Categories
                        </span>
                        <button id="policyExportBtn" type="button" class="btn btn-secondary" title="Export policies as CSV" style="margin-left:12px;">
                            Policy Export
                        </button>
                    </div>

                    <div class="categories-grid">
                        @if (Model.CategoriesToDisplay?.Any() == true)
                        {
                            foreach (var category in Model.CategoriesToDisplay)
                            {
                                if (category.ContentType.Alias == "HandbookCategoryCard")
                                {
                                    var typedCategory = category as Umbraco.Cms.Web.Common.PublishedModels.HandbookCategoryCard;
                                    @await Html.PartialAsync("~/Views/Partials/Shared/_CategoryCard.cshtml", typedCategory)
                                }
                            }
                        }
                        else
                        {
                            <div class="empty-state">
                                <div class="empty-state__content">
                                    <i data-lucide="folders"></i>
                                    <h3 class="empty-state__title neumo-heading-bold">No Categories Available</h3>
                                    <p class="empty-state__description neumo-body">
                                        Categories will appear here as they are added.
                                    </p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Tab Content -->
    <div id="content-support" class="tab-content">
        @await Html.PartialAsync("~/Views/Partials/Shared/_FAQSupportContent.cshtml")
    </div>

</div>

<!-- Tab switching JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Listen for tab change events from sidebar navigation
    document.addEventListener('tabChanged', function(event) {
        const tabId = event.detail.tabId;
        switchToTab(tabId);
    });
    
    // Handle hash navigation (when arriving via links like /#handbook)
    function initializeFromHash() {
        const hash = window.location.hash.substring(1); // Remove the #
        if (hash && ['welcome', 'guide', 'handbook', 'support'].includes(hash)) {
            switchToTab(hash);
            localStorage.setItem('activeTab', hash);
            
            // Update sidebar navigation state
            const navItems = document.querySelectorAll('[data-tab]');
            navItems.forEach(nav => {
                nav.classList.remove('sidebar-nav__button--active');
                if (nav.getAttribute('data-tab') === hash) {
                    nav.classList.add('sidebar-nav__button--active');
                }
            });
        } else {
            // Initialize with saved tab or default to welcome
            const savedTab = localStorage.getItem('activeTab') || 'welcome';
            switchToTab(savedTab);
        }
    }
    
    // Initialize on page load
    initializeFromHash();
    
    // Handle browser back/forward navigation
    window.addEventListener('hashchange', initializeFromHash);
});

function switchToTab(tabId) {
    // Hide all tab content
    const allTabContent = document.querySelectorAll('.tab-content');
    allTabContent.forEach(content => {
        content.classList.remove('tab-content--active');
    });
    
    // Show the selected tab content
    const targetContent = document.getElementById(`content-${tabId}`);
    if (targetContent) {
        targetContent.classList.add('tab-content--active');
    }
    
    // Update URL hash without triggering navigation
    if (window.location.hash !== `#${tabId}`) {
        history.replaceState(null, null, `#${tabId}`);
    }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('policyExportBtn');
    if (!btn) return;
    btn.addEventListener('click', function() {
        // Open API endpoint to download CSV
        const url = '/api/PolicyExport/ExportCsv';
        // Trigger file download
        window.location.href = url;
    });
});
</script>
